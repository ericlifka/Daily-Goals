// Generated by CoffeeScript 1.6.3
(function() {
  var Data, Time;

  window.App = Ember.Application.create();

  if (navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry)/)) {
    App.deferReadiness();
    document.addEventListener("deviceready", function() {
      return App.advanceReadiness();
    });
  }

  App.Router.map(function() {
    this.route('new');
    return this.route('detail', {
      path: '/detail/:goal_id'
    });
  });

  App.CalendarController = Ember.ObjectController.extend();

  App.CalendarView = Ember.View.extend({
    weekdayLabels: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
    didInsertElement: function() {
      return this.renderCalendars();
    },
    renderCalendars: function() {
      this.goal = this.get('controller.model');
      this.startDate = moment(this.goal.get('startDate'));
      this.today = App.time.today();
      this.months = this.goal.monthsWithEntries();
      console.log(this.startDate);
      if (!this.months.length) {
        return this.noData();
      } else {
        return this.nextMonth();
      }
    },
    noData: function() {
      return this.$().text("You don't have any entries for this goal yet");
    },
    nextMonth: function() {
      var currentMonth;
      currentMonth = _.last(this.months);
      this.months = _.initial(this.months);
      if (currentMonth) {
        this.displayCurrentMonth(currentMonth);
        return this.nextMonth();
      }
    },
    displayCurrentMonth: function(currentMonth) {
      var _ref;
      _ref = currentMonth.split('.'), this.currentYear = _ref[0], this.currentMonth = _ref[1];
      this.calculateMonthRange();
      return this.createMonthTable();
    },
    calculateMonthRange: function() {
      var m;
      m = moment({
        years: this.currentYear,
        months: this.currentMonth
      });
      this.monthStart = m.startOf('month').day();
      return this.monthLength = m.daysInMonth();
    },
    createMonthTable: function() {
      this.table = $('<table>');
      this.createCaption();
      this.createHeader();
      this.populateDays();
      return this.table.appendTo(this.$());
    },
    createCaption: function() {
      var caption;
      caption = $('<caption>');
      caption.text(App.time.calendarMonthDisplay(this.currentYear, this.currentMonth));
      return caption.appendTo(this.table);
    },
    createHeader: function() {
      var day, header, _i, _len, _ref;
      header = $('<tr>');
      _ref = this.weekdayLabels;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        day = _ref[_i];
        header.append($('<th>').text(day));
      }
      return header.appendTo(this.table);
    },
    populateDays: function() {
      var _results;
      this.currentDay = 1;
      _results = [];
      while (this.currentDay <= this.monthLength) {
        _results.push(this.nextRow());
      }
      return _results;
    },
    nextRow: function() {
      var dayOfTheWeek, _i;
      this.currentRow = $('<tr>');
      for (dayOfTheWeek = _i = 0; _i <= 6; dayOfTheWeek = ++_i) {
        this.nextDay(dayOfTheWeek);
      }
      return this.currentRow.appendTo(this.table);
    },
    nextDay: function(dayOfTheWeek) {
      this.currentCell = $('<td>');
      if (this.currentDayWithinMonth(dayOfTheWeek)) {
        this.currentCell.text(this.currentDay);
        this.styleCurrentDay();
        this.currentDay += 1;
      }
      return this.currentCell.appendTo(this.currentRow);
    },
    currentDayWithinMonth: function(dayOfTheWeek) {
      if (this.currentDay <= this.monthLength) {
        return this.currentDay > 1 || dayOfTheWeek >= this.monthStart;
      } else {
        return false;
      }
    },
    styleCurrentDay: function() {
      var currentDate;
      currentDate = this.currentDate();
      if (currentDate.isSame(this.startDate, 'day')) {
        this.currentCell.addClass('start');
      }
      if (currentDate.isSame(this.today, 'day')) {
        this.currentCell.addClass('today');
      }
      if (this.withinGoalRange(currentDate)) {
        if (this.goal.hasEntryFor(currentDate)) {
          return this.currentCell.addClass('complete');
        } else {
          return this.currentCell.addClass('failed');
        }
      }
    },
    currentDate: function() {
      return App.time.date(this.currentYear, this.currentMonth, this.currentDay);
    },
    withinGoalRange: function(date) {
      return this.onOrBefore(this.startDate, date) && this.onOrBefore(date, this.today);
    },
    onOrBefore: function(testDate, boundary) {
      return testDate.isBefore(boundary, 'day') || testDate.isSame(boundary, 'day');
    }
  });

  /*
  {
      version: 1
      goals: [
          {
              name: string
              trackNumber: boolean
              lastCompletedOn: ISO Date String
              frequency: {
                  interval: string in set ['month', 'day', 'year']
                  daysPerPeriod: integer
                  excludeWeekends: boolean
              }
              entries: [
                  {
                      date: ISO Date String,
                      numberValue: number (this field only exists on goals with 'trackNumber' set to true)
                  }
                  ...
              ]
          }
          ...
      ]
  }
  */


  Data = Ember.Object.extend({
    id_counter: 1,
    currentDataVersion: 2,
    defaultData: {
      "version": 1,
      "goals": []
    },
    dataLoadedPromise: new $.Deferred(),
    initialize: function(dataObject) {
      var goal;
      this.goals = Ember.A((function() {
        var _i, _len, _ref, _results;
        _ref = dataObject.goals;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          goal = _ref[_i];
          _results.push(this.goalFromJson(goal));
        }
        return _results;
      }).call(this));
      if (dataObject.version < 2) {
        this.migrateTo2();
      }
      return this.dataLoadedPromise.resolve();
    },
    allGoals: function() {
      var promise,
        _this = this;
      promise = new $.Deferred();
      this.dataLoadedPromise.then(function() {
        return promise.resolve(_this.goals);
      });
      return promise.promise();
    },
    getGoalById: function(id) {
      var promise,
        _this = this;
      if (typeof id === 'string') {
        id = parseInt(id);
      }
      promise = new $.Deferred();
      this.dataLoadedPromise.then(function() {
        var goal;
        goal = _.find(_this.goals, function(g) {
          return id === g.get('id');
        });
        return promise.resolve(goal);
      });
      return promise.promise();
    },
    newGoal: function(_arg) {
      var daysPerPeriod, excludeWeekends, goal, interval, name, trackNumber;
      name = _arg.name, trackNumber = _arg.trackNumber, interval = _arg.interval, daysPerPeriod = _arg.daysPerPeriod, excludeWeekends = _arg.excludeWeekends;
      if (!name) {
        alert('Goal name is required');
        return false;
      } else if (this.findGoalByName(name)) {
        alert('Duplicate goal name');
        return false;
      } else {
        goal = App.GoalModel.create({
          id: this.newId(),
          name: name,
          trackNumber: trackNumber || false,
          entries: [],
          lastCompletedOn: null,
          startDate: App.time.todaysKey(),
          frequency: {
            interval: interval,
            daysPerPeriod: parseInt(daysPerPeriod) || 1,
            excludeWeekends: excludeWeekends || false
          }
        });
        this.goals.pushObject(goal);
        this.saveGoals();
        return true;
      }
    },
    deleteGoal: function(goal) {
      this.goals.removeObject(goal);
      return this.saveGoals();
    },
    findGoalByName: function(name) {
      return _.find(this.goals, function(goal) {
        return goal.get('name') === name;
      });
    },
    saveGoals: function() {
      var json;
      json = JSON.stringify({
        version: this.currentDataVersion,
        goals: this.getGoalsJsonArray()
      });
      return this.writeJsonToFile(json);
    },
    getGoalsJsonArray: function() {
      var goal, _i, _len, _ref, _results;
      _ref = this.goals;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        goal = _ref[_i];
        _results.push(this.goalToJson(goal));
      }
      return _results;
    },
    goalFromJson: function(json) {
      return App.GoalModel.create(json, {
        id: this.newId()
      });
    },
    goalToJson: function(goal) {
      return {
        name: goal.name,
        trackNumber: goal.trackNumber,
        lastCompletedOn: goal.lastCompletedOn,
        entries: goal.entries,
        startDate: goal.startDate,
        frequency: {
          interval: goal.frequency.interval,
          daysPerPeriod: goal.frequency.daysPerPeriod,
          excludeWeekends: goal.frequency.excludeWeekends
        }
      };
    },
    newId: function() {
      return this.id_counter++;
    },
    readDataFromFile: function() {
      var fileReadFailed, fileReadSucceeded,
        _this = this;
      fileReadFailed = function(error) {
        console.log(error);
        return _this.initialize(_this.defaultData);
      };
      fileReadSucceeded = function(event) {
        var error;
        try {
          _this.initialize(JSON.parse(event.target.result));
          return console.log('data read and app initialized');
        } catch (_error) {
          error = _error;
          return fileReadFailed(error);
        }
      };
      return window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fs) {
        return fs.root.getFile("goals.json", null, function(fileEntry) {
          return fileEntry.file(function(file) {
            var reader;
            reader = new FileReader();
            reader.onerror = fileReadFailed;
            reader.onload = fileReadSucceeded;
            return reader.readAsText(file);
          }, fileReadFailed);
        }, fileReadFailed);
      }, fileReadFailed);
    },
    writeJsonToFile: function(json) {
      var fileWriteFailed,
        _this = this;
      fileWriteFailed = function(error) {
        return alert("Error occurred while saving: " + error);
      };
      return window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fs) {
        return fs.root.getFile("goals.json", {
          create: true,
          exclusive: false
        }, function(fileEntry) {
          return fileEntry.createWriter(function(writer) {
            writer.write(json);
            return console.log('write succeeded');
          }, fileWriteFailed);
        }, fileWriteFailed);
      }, fileWriteFailed);
    },
    migrateTo2: function() {
      var _this = this;
      console.log('Running migration: v1 to v2');
      return _.each(this.goals, function(goal) {
        return _this.setStartDate(goal);
      });
    },
    setStartDate: function(goal) {
      var firstEntry, startDate;
      firstEntry = _.last(goal.entries);
      startDate = firstEntry ? firstEntry.date : App.time.todaysKey();
      return goal.set('startDate', startDate);
    },
    readInFakeData: function() {
      return this.initialize({
        version: 1,
        goals: [
          {
            name: "something",
            trackNumber: false,
            lastCompletedOn: null,
            frequency: {
              interval: 'day',
              daysPerPeriod: 1,
              excludeWeekends: false
            },
            entries: [
              {
                date: "2013-11-20T05:00:00.000Z"
              }, {
                date: "2013-11-19T05:00:00.000Z"
              }, {
                date: "2013-11-18T05:00:00.000Z"
              }, {
                date: "2013-11-17T05:00:00.000Z"
              }, {
                date: "2013-11-16T05:00:00.000Z"
              }, {
                date: "2013-11-15T05:00:00.000Z"
              }, {
                date: "2013-11-14T05:00:00.000Z"
              }, {
                date: "2013-11-13T05:00:00.000Z"
              }, {
                date: "2013-11-12T05:00:00.000Z"
              }, {
                date: "2013-11-11T05:00:00.000Z"
              }, {
                date: "2013-11-10T05:00:00.000Z"
              }
            ]
          }, {
            name: "weekly test",
            trackNumber: false,
            lastCompletedOn: null,
            frequency: {
              interval: 'week',
              daysPerPeriod: 2,
              excludeWeekends: false
            },
            entries: [
              {
                date: "2013-11-19T05:00:00.000Z"
              }, {
                date: "2013-11-17T05:00:00.000Z"
              }, {
                date: "2013-11-15T05:00:00.000Z"
              }, {
                date: "2013-11-14T05:00:00.000Z"
              }, {
                date: "2013-11-13T05:00:00.000Z"
              }, {
                date: "2013-11-12T05:00:00.000Z"
              }, {
                date: "2013-11-11T05:00:00.000Z"
              }, {
                date: "2013-11-10T05:00:00.000Z"
              }, {
                date: "2013-10-31T05:00:00.000Z"
              }, {
                date: "2013-10-30T05:00:00.000Z"
              }, {
                date: "2013-10-29T05:00:00.000Z"
              }
            ]
          }
        ]
      });
    }
  });

  App.data = Data.create();

  if (navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry)/)) {
    console.log('mobile device detected, waiting for deviceready event');
    document.addEventListener("deviceready", function() {
      console.log('deviceready fired');
      return App.data.readDataFromFile();
    });
  } else {
    jQuery(function() {
      App.data.writeJsonToFile = (function() {});
      return App.data.readInFakeData();
    });
  }

  App.DetailRoute = Ember.Route.extend({
    model: function(params) {
      return App.data.getGoalById(params.goal_id);
    },
    afterModel: function(goal) {
      if (!goal) {
        return this.transitionTo('index');
      }
    },
    actions: {
      "delete": function() {
        return this.transitionTo('index');
      }
    }
  });

  App.DetailController = Ember.ObjectController.extend({
    actions: {
      "delete": function() {
        if (confirm("Delete this goal?")) {
          App.data.deleteGoal(this.get('model'));
          return true;
        } else {
          return false;
        }
      }
    }
  });

  App.GoalListEntryView = Ember.View.extend({
    classNameBindings: [':goal-list-entry', 'goalStatus'],
    goalStatus: Ember.computed('controller.statusForThisPeriod', function() {
      return this.get('controller.statusForThisPeriod');
    })
  });

  App.GoalListEntryController = Ember.ObjectController.extend({
    actions: {
      complete: function() {
        return this.get('model').addEntry(this.get('numberInput'));
      }
    }
  });

  App.GoalModel = Ember.Object.extend({
    hasEntryForToday: Ember.computed('lastCompletedOn', function() {
      return App.time.todaysKey() === this.get('lastCompletedOn');
    }),
    nonDayPeriodGoal: Ember.computed('frequency.interval', function() {
      return 'day' !== this.get('frequency.interval');
    }),
    frequencyDescription: Ember.computed('frequency.interval', 'frequency.daysPerPeriod', function() {
      var count, interval, number, period, prelude;
      interval = this.get('frequency.interval');
      count = this.get('frequency.daysPerPeriod');
      prelude = "Meet this goal ";
      if (interval === 'day') {
        return "" + prelude + " Every Day";
      } else {
        number = (function() {
          switch (false) {
            case count !== 1:
              return "Once";
            case count !== 2:
              return "Twice";
            default:
              return "" + count + " times";
          }
        })();
        period = (function() {
          switch (false) {
            case interval !== 'week':
              return "Week";
            default:
              return "Month";
          }
        })();
        return "" + prelude + " at least " + number + " a " + period;
      }
    }),
    statusReport: Ember.computed('frequency.interval', 'entries.@each', function() {
      var count, period, plural;
      count = this.entriesCompletedThisPeriod();
      plural = count === 1 ? "" : "s";
      period = this.get('frequency.interval');
      return "This goal has been completed " + count + " time" + plural + " this " + period + ".";
    }),
    statusForThisPeriod: Ember.computed('entries.@each', 'hasEntryForToday', function() {
      var completed, daysRemaining, remaining, required;
      if ('day' === this.get('frequency.interval')) {
        if (this.get('hasEntryForToday')) {
          return 'complete';
        } else {
          return 'uncomplete';
        }
      } else {
        completed = this.entriesCompletedThisPeriod();
        required = this.get('frequency.daysPerPeriod');
        remaining = required - completed;
        daysRemaining = App.time.daysLeftInPeriod(this.get('frequency.interval'));
        if (!this.get('hasEntryForToday')) {
          daysRemaining += 1;
        }
        switch (false) {
          case !(remaining <= 0):
            return 'complete';
          case daysRemaining !== remaining:
            return 'danger';
          case !(remaining > daysRemaining):
            return 'failed';
          default:
            return 'uncomplete';
        }
      }
    }),
    goalCompleteForPeriod: function() {
      var completed;
      if ('day' === this.get('frequency.interval')) {
        return this.get('hasEntryForToday');
      } else {
        completed = this.entriesCompletedThisPeriod();
        return completed >= this.get('frequency.daysPerPeriod');
      }
    },
    addEntry: function(goalValue) {
      var entry;
      entry = {
        date: App.time.todaysKey(),
        goalValue: goalValue
      };
      this.get('entries').unshiftObject(entry);
      this.set('lastCompletedOn', entry.date);
      return App.data.saveGoals();
    },
    entriesCompletedThisPeriod: function() {
      return this.entriesForThisPeriod().length;
    },
    entriesForThisPeriod: function() {
      var currentPeriod, intervalFunction, now;
      now = moment();
      intervalFunction = 'week' === this.get('frequency.interval') ? now.weeks : now.months;
      currentPeriod = intervalFunction.apply(now);
      return _.filter(this.entries, function(entry) {
        return currentPeriod === intervalFunction.apply(moment(entry.date));
      });
    },
    hasEntryFor: function(time) {
      if (moment.isMoment(time)) {
        time = time.toISOString();
      }
      return _.find(this.entries, function(entry) {
        return entry.date === time;
      });
    },
    monthsWithEntries: function() {
      var monthGroups;
      monthGroups = _.groupBy(this.entries, function(entry) {
        return App.time.sortableMonthKey(entry.date);
      });
      return _.sortBy(_.keys(monthGroups), function(i) {
        return i;
      });
    }
  });

  App.IndexRoute = Ember.Route.extend({
    model: function() {
      return App.data.allGoals();
    },
    actions: {
      detail: function(goal) {
        return this.transitionTo('detail', goal);
      }
    }
  });

  App.IndexController = Ember.ArrayController.extend({
    hasGoals: Ember.computed('length', function() {
      return 0 < this.get('length');
    }),
    filterByInterval: function(interval) {
      var _this = this;
      return _.filter(this.get('model'), function(goal) {
        return interval === goal.get('frequency.interval');
      });
    },
    filterByUnfinished: function(goals) {
      var _this = this;
      return _.filter(goals, function(goal) {
        var complete;
        complete = goal.get('hasEntryForToday') || goal.get('frequency.excludeWeekends') && App.get('time.isWeekend');
        return !complete;
      });
    },
    dailyGoals: Ember.computed('model.@each', function() {
      return this.filterByInterval('day');
    }),
    weeklyGoals: Ember.computed('model.@each', function() {
      return this.filterByInterval('week');
    }),
    monthlyGoals: Ember.computed('model.@each', function() {
      return this.filterByInterval('month');
    }),
    unfinishedDailyGoals: Ember.computed('dailyGoals.@each.hasEntryForToday', 'showAll', function() {
      if (this.get('showAll')) {
        return this.get('dailyGoals');
      } else {
        return this.filterByUnfinished(this.get('dailyGoals'));
      }
    }),
    unfinishedWeeklyGoals: Ember.computed('weeklyGoals.@each.hasEntryForToday', 'showAll', function() {
      if (this.get('showAll')) {
        return this.get('weeklyGoals');
      } else {
        return this.filterByUnfinished(this.get('weeklyGoals'));
      }
    }),
    unfinishedMonthlyGoals: Ember.computed('monthlyGoals.@each.hasEntryForToday', 'showAll', function() {
      if (this.get('showAll')) {
        return this.get('monthlyGoals');
      } else {
        return this.filterByUnfinished(this.get('monthlyGoals'));
      }
    }),
    hasDailyGoals: Ember.computed('dailyGoals.length', function() {
      return 0 < this.get('dailyGoals.length');
    }),
    hasWeeklyGoals: Ember.computed('weeklyGoals.length', function() {
      return 0 < this.get('weeklyGoals.length');
    }),
    hasMonthlyGoals: Ember.computed('monthlyGoals.length', function() {
      return 0 < this.get('monthlyGoals.length');
    }),
    hasUnfinishedDailyGoals: Ember.computed('unfinishedDailyGoals.length', function() {
      return 0 < this.get('unfinishedDailyGoals.length');
    }),
    hasUnfinishedWeeklyGoals: Ember.computed('unfinishedWeeklyGoals.length', function() {
      return 0 < this.get('unfinishedWeeklyGoals.length');
    }),
    hasUnfinishedMonthlyGoals: Ember.computed('unfinishedMonthlyGoals.length', function() {
      return 0 < this.get('unfinishedMonthlyGoals.length');
    }),
    actions: {
      toggleShowAll: function() {
        return this.set('showAll', !this.get('showAll'));
      }
    }
  });

  App.NewRoute = Ember.Route.extend({
    actions: {
      save: function() {
        return this.transitionTo('index');
      },
      cancel: function() {
        return this.transitionTo('index');
      }
    }
  });

  App.NewController = Ember.Controller.extend({
    frequencyOptions: [
      {
        label: 'Every Day',
        id: 'day'
      }, {
        label: 'X Days a Week',
        id: 'week'
      }, {
        label: 'X Days a Month',
        id: 'month'
      }
    ],
    inputTypeOptions: [
      {
        label: 'Checkbox',
        id: 'checkbox'
      }, {
        label: 'Number',
        id: 'number'
      }
    ],
    daysPerPeriodSelection: Ember.computed('goalFrequency', function() {
      var _ref;
      return (_ref = this.get('goalFrequency')) === 'week' || _ref === 'month';
    }),
    saveForm: function() {
      return App.data.newGoal({
        name: this.get('goalName'),
        trackNumber: this.get('addNumberInput'),
        interval: this.get('goalFrequency'),
        daysPerPeriod: this.get('daysPerPeriod'),
        excludeWeekends: this.get('excludeWeekends')
      });
    },
    clearForm: function() {
      this.set('goalName', '');
      this.set('addNumberInput', false);
      this.set('goalFrequency', '');
      this.set('daysPerPeriod', '');
      this.set('excludeWeekends', false);
      this.removeErrorHighlight();
      return true;
    },
    highlightInputErrors: function() {
      return $('.form-group.required').addClass('has-error');
    },
    removeErrorHighlight: function() {
      return $('.form-group.required').removeClass('has-error');
    },
    actions: {
      save: function() {
        if (this.saveForm()) {
          return this.clearForm();
        } else {
          return this.highlightInputErrors();
        }
      },
      cancel: function() {
        return this.clearForm();
      }
    }
  });

  Time = Ember.Object.extend({
    todayDisplay: Ember.computed(function() {
      return this.today().format('dddd MMMM Do');
    }),
    isWeekend: Ember.computed(function() {
      var _ref;
      return (_ref = this.today().days()) === 0 || _ref === 6;
    }),
    calendarMonthDisplay: function(year, month) {
      return moment({
        year: year,
        month: month
      }).format('MMMM YYYY');
    },
    today: function() {
      var n;
      n = moment();
      return moment({
        years: n.year(),
        months: n.month(),
        days: n.date()
      });
    },
    date: function(year, month, day) {
      return moment({
        years: year,
        months: month,
        days: day
      });
    },
    todaysKey: function() {
      return this.today().toISOString();
    },
    dateKey: function(year, month, day) {
      return this.date(year, month, day).toISOString();
    },
    daysLeftInPeriod: function(period) {
      switch (period) {
        case 'day':
          return 0;
        case 'week':
          return this.daysLeftInWeek();
        case 'month':
          return this.daysLeftInMonth();
      }
    },
    daysLeftInWeek: function() {
      return 6 - this.today().days();
    },
    daysLeftInMonth: function() {
      var today;
      today = this.today();
      return today.daysInMonth() - today.date();
    },
    sortableMonthKey: function(dateString) {
      var date;
      date = moment(dateString);
      return "" + (date.years()) + "." + (this.paddNumber(date.months()));
    },
    paddNumber: function(number) {
      var padding;
      padding = number < 10 ? "0" : "";
      return "" + padding + number;
    }
  });

  App.time = Time.create();

}).call(this);
